%************************************************
\chapter{Design Choices}\label{ch:choices}
%************************************************

\section{Communication}\label{sec:communication}

The main specification that must be decided before we can start working on the
design is the communication method.

% TODO : blurb about what's needed : frequency, MAC, PHY, protocols, etc.

In order to create a useful platform for home automation, the following features
are desirable:

\begin{itemize}
  \item \emph{Universal} : frequencies, protocols should be universal, so that
    the same hardware can be used anywhere without needing to make
    region-specific versions.

  \item \emph{Popular network stack} : <++>
    % proprietary, vendor-specific : bad. if the chip maker decides to drop
    % support, we're fucked. ZigBee is okay because it's very widespread, but it
    % costs money. 
    % supported by more devices, more libraries written, more stable, more
    % documentation, etc.

  \item \emph{Interoperability} : small sensor devices are not very useful on
    their own. It is important to be able to extend the network. The best way to
    achieve this, in the author's opinion, is to rely on \emph{open standards},
    which would allow devices from multiple vendors to communicate using
    a common set of standards and protocols. 

  \item \emph{Reachable from anywhere} : if the application requires it, each
    node must be reachable from anywhere the user may be. It is important for
    the sensor network to be able to 
    % helps with interoperability
  \item \emph{Mesh topology (or similar)} : This can drastically improve the
    range of a sensor network while keeping infrastructure costs low. See
    \autoref{sec:topology} for more details.
\end{itemize}<++>

% TODO : these references

We must add references to \citep{shelby2010} and \citep{hunn2010}.

When mentioning IEEE~802.15.4, mention \citep{ieee802154}.

\begin{quotation}
Although the differences in radio specification have some effect, it is
nothing like as great as that of the higher-layer stack.

    --- \defcitealias{hunn2010}{Essentials of Short-Range Wireless}
    \citetalias{hunn2010} \citep[pg. 20]{hunn2010}
\end{quotation}


\subsection{IPv6}

On the subject of communication, it is important to mention how these wireless
sensor networks will be connected to the outside world. 

%TODO : ideas
reachable from anywhere


\section{Topology}\label{sec:topology}

Wireless devices have the possibility to form links with any other device within
their range. It is therefore important to define how these devices will
communicate together : whether we will simply link two devices together in
a point-to-point fashion (essentially replacing a wire with a radio link), to
broadcast from one device to all receivers within range, or to use a more
complex topology.

There are many possibilities available\footnote{for more examples of topologies,
see \citep[sec. 2.3.4]{hunn2010}.}, but we will only cover the most popular
option : mesh topology.

One of the differentiating factors of the IEEE 802.15.4 standard is the ability
to form a mesh network. This is one of the most complex topologies to implement,
but luckily its operation is covered by existing user libraries already, which
makes it an excellent choice for developing robust applications.

In a mesh network, nodes are differentiated by their role. In this case, there
are two possibilities. \emph{End nodes} are low-powered nodes that spend most of
their time asleep. In some cases, they will wake up periodically to check for
any pending messages. In others, they will remain asleep until they have data to
transmit. These devices are interconnected by \emph{routers} : nodes that are
always awake, ready to relay messages between other nodes.

\autoref{fig:mesh-topology} illustrates the way that nodes are connected
together. The white circles are end nodes, whilst the grey circles represent
routers. As their name suggests, \emph{end} nodes are only meant to be at the
edges of the network and will not relay messages. The black circle is a special
kind of router node, called the \emph{coordinator}. This node handles the
creation and management of the network and must always be present.
% TODO : perhaps mention beacon mode

In practice, this topology has two important advantages. First, it allows the
network to be extended with very little infrastructure cost. Indeed, if two end
nodes are too far apart, all that is needed is to place one or more router nodes
in between them. These will then automatically relay data between the neighbour
nodes. Second, having multiple nodes in the same area increases the robustness
of the network. When transmitting a message, nodes will auto-discover the most
efficient path to deliver it. If some nodes fail, or get moved around or removed
from the network, the nodes will find new paths to deliver the data. 

% TODO : rearrange this ^ and that v  to blend them together

These two scenarios are likely occurences in a domestic environment : in the
first case, it is not unlikely that devices will only achieve a range of one
storey vertically. If the network required fixed infrastructure (such as in
a WiFi network for instance), each storey would need to house an access point.
In the case of a mesh network, the nodes on one floor will relay the messages
between the floor above and the floor below. 

% TODO : figure, mesh network page 48 of fundamentals of short range wireless


\section{Operating frequency}\label{sec:frequency}

The first choice to be made is the frequency of operation. This is quite an
important topic as it will impose restrictions on the type of networking
protocols that will be available. Some frequency bands can cause interference
with common household equiment more than others. Furthermore, some choices also
limit the target markets : some frequency bands are not available in all
countries around the world or require special licenses.

We will cover only the most common choices and explain our reasoning for each
one. Since the devices under development are to be used in a domestic
environment by a regular consumer, they must be usable without a specific radio
license. It would also be preferable if the devices did not have to be modified
according to the market they will be deployed in. The frequency choices are
grouped in the \ac{ISM} band, which makes them possible to use license-free, but
also subject to interference from other household devices such as microwave
ovens.

\subsection{433 MHz}

The 433 Mhz ISM band (\SIrange{433.05}{434.79}{MHz})
\footnote{\url{http://www.bakom.admin.ch/themen/frequenzen/00652/00653/index.html?lang=en}
National Frequency Allocation Plan} is a very popular choice for short range,
low cost devices. Its use is mainly for remote controlled devices, such as light
switches or garage door openers. It is usually used for one-way transmissions.

In Switzerland, the power limit for \SI{433}{MHz} is \SI{1}{mW} at 100\% duty
cycle, or \SI{10}{mW} at 10\% duty cycle.

% TODO : find the OFCOM document with power limits per frequency band

Although quite common in Europe for cheap home automation devices, it is not
usable in the United States (known as \emph{Region
2})\footnote{For more details, refer to the documentation about the
  International Telecommunication Union regions
  : \url{http://life.itu.ch/radioclub/rr/art05.htm}.}.
Therefore, there are few commercial solutions and chips available using this
frequency. At the time of writing, no widespread networking solution was found
using this particular frequency band.  Furthermore, any developments made using
such a device would have to be repeated in another frequency band if the devices
were to be used outside of Europe and the Middle East (\emph{Region 1}).

% TODO : why not make our own solution? explain.

\subsection{Sub-GHz}

In addition to the \SI{433}{Mhz} \ac{ISM} band, there is another option,
commonly referred to as the \emph{Sub-Ghz} band, which is centered around
\SI{863.5}{Mhz} in Region 1, and \SI{915}{Mhz} in Region 2.

% TODO : reword the following paragraph
Devices operating in this frequency range are becoming increasingly common. Most
major chip manufacturers are producing chips that can switch between these bands
( 433 / 868 /\SI{915}{Mhz}).

The main appeal of the sub-Ghz band is that it is less crowded than the 2.4 Ghz
band. This is becoming increasingly true with time as we are seeing more and
more devices in this part of the spectrum. Laptop computers, home audio systems,
smartphones all contribute to noise in this band, which is shared between Wi-Fi,
Bluetooth, ZigBee and many other technologies. Therefore it can be quite
attractive to develop a sensor network which functions outside of this frequency
range, in hopes that it will be more reliable.

The greatest disadvantage of this frequency range is the lack of a common band
between regions. If a device is developed for use in Europe, a different version
will have to be made for the North American market.

\subsection{2.4 GHz}

This band is currently the most popular part of the spectrum for personal
electronic devices that must communicate together. Current applications include
WiFi, Bluetooth, and the IEEE 802.15.4 standard, which is the basis for ZigBee
and \ac{6LoWPAN}, which will be covered elsewhere in this report.

This popularity has its advantages as well as drawbacks. One of the main
advantages is that there are a very wide variety of devices now available that
operate at this frequency. 

% TODO : define ``elsewhere''

In spite of [all this], the author's previous experience with ZigBee devices has
shown that in a typical domestic environment, with many wireless devices active,
it is possible to achieve a reliable link between devices in different rooms and
on different floors. Furthermore, we will be favouring a networking stack that
can provide mesh capabilities. This will lower the importance of the range, as
extending the range of the network is a simple matter of adding a cheap repeater
(router) device at some point in the data path. For example, if communication
cannot be established between the first and third floors, a router can be placed
on the second floor to bridge the gap between those two domains.


\section{Comparison}

Here, a table comparing the advantages/disadvantages of each tech


\begin{table}
    \myfloatalign
  \begin{tabularx}{\textwidth}{Xlll} \toprule
    \tableheadline{Criteria}
    & \tableheadline{433 MHz}
    & \tableheadline{868 / 915 MHz}
    & \tableheadline{2.4 GHz} \\ \midrule
    Region Independent    & Y/N & N & Y \\
    Mesh networking stack & N   & Y & Y \\
    \bottomrule
  \end{tabularx}
  \caption[Frequency comparison]{Frequency comparison}
  \label{tab:frequency-comparison}
\end{table}

\section{In hindsight}

What have we learned? Would it have been better to choose a different frequency?

\section{Network stacks}\label{sec:stacks}

A table comparing ZigBee (various versions), Z-Wave, Bluetooth, 6LoWPAN etc
would be nice.
Explain the mostly subjective reasons for choosing a solution based on open
standards, IETF approved drafts etc. 

Explain that the choice between ZigBee and 6LoWPAN is more subjective than
technical, and that it's difficult to predict where the market will go in the
near future, and that the technology for the internet of things has not been
decided yet. However, it is very likely that it will work only if it is based on
open standards and if everyone collaborates. This is why we chose IEEE 802.15.4
on 2.4 GHz, because the same hardware would allow us to make a ZigBee or 6LoWPAN
compatible network.

\section{RF Chips}\label{sec:chips}

Here, we'll talk about the various microcontrollers on the market

\subsection{Multi-chip solution vs. System-on-Chip}

Do a cost comparison. 
Explain technical advantages (notably space saved on PCB) and disadvantages
(software is more complex, less separation of application vs stack).

Mention some advantages like the over-the-air bootloader for STM32 and the
Jennet-IP solution (and why we couldn't use it!) \footnote{Jennet IP was to be
released under an open source license in the fourth quarter of 2011
: \url{http://www.eetimes.com/electronics-news/4216038/Home-or-commercial-lighting-comes-under-Internet-control}
but it's still not available today}

Now we'll want to somehow format the huge excel table into something we can
include in a report\ldots hmmm.

% TODO : incorporate this somewhere

From a portability and cost point, it may be preferable to have the networking
stack and hardware in one dedicated and cheap module, and adapt the target
hardware to the desired application. There is no need to use a device with
a Cortex M3 core to read a temperature sensor or turn off a light. However, some
application may call for more processing power, such as an M4 or an FPGA, in
which case the processing power of the STM32W will be wasted, and it will simply
be added to the cost for nothing.

\section{Observations}

What we've deduced from the project : was it the right choice? What could we
have done better?

\begin{itemize}
  \item \emph{Power consumption} : original specifications called for an audio
    amplification stage, which would have used tens of micro Amps.
    % TODO : get proper data
    Therefore a difference between 400nA and 20nA was not significant. However,
    if the system is designed to be completely turned off most of the time, then
    a combination of an ultra low power microcontroller with a CC2420 or atmel
    chip would be much more efficient.
  \item \emph{Antenna diversity} : performance in the 2.4 Ghz band is pretty
    random (show some examples!). Very sensitive to positioning and orientation.
    Some chips now offer antenna diversity (link to very recent Atmel chip),
    which could be a very interesting option if space permits. Especially if
    using PCB antenna, would not increase costs too much.
\end{itemize}


\section{Microcontroller}

A few words on the STM32, what is specific about it, talk about the M3 core, the
instruction set, cpu clock
